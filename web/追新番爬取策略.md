# 如何爬取并同步追新番

尽管人人影视已经倒下了，但是目前看来，追新番依旧在**正常更新熟肉**。

本文档将描述如何爬取并同步追新番的大概思路

# 1. 现状分析

[追新番](http://www.zhuixinfan.com/main.php)是人人影视日剧组的别名，主要翻译日剧作品。

好消息是， 目前追新番的网站还能够正常访问，并且还在更新熟肉。

坏消息是，追新番开了JS质询，也就是俗称的CC检测。因此，常规的requests+beautiful soup是行不通的。 在这种情况下，唯一可行的爬虫方式是使用selenium

另外一个更好的消息是，追新番使用的是discuz，因此默认也支持rss订阅。rss链接如下：
http://www.zhuixinfan.com/main.php?mod=rss&pid=1262

rss是结构化的XML数据，非常适合程序处理，因此直接使用feedparser就可以了。

另外一个问题是，不知道服务器原站在哪里。不过这个问题不大。

# 2. 爬取策略

在这种情况下，只需要指定pid，然后用 selenium 去访问，等待cc检测结束之后展示正常页面，把XML保存下来，交给feedparser就可以了

# 3. 合并策略

首先需要搞清楚的问题是，追新番的数据和人人影视的离线数据是什么时候出现了不同步？ 鉴于《天国与地狱》是比较新的剧，推测日剧组大概只翻译了1000多部剧集。

不同步的现象分为两种：

* 新播出的剧集：人人影视数据库完全没有记录
* 旧剧新集：已有的剧，新播出了SP或者下一季，这个时候离线数据库的信息也是不准确的

## 3.1 完整合并策略

这里不是很好搞。一个完整的合并策略是这样的：

1. 遍历追新番，从pid=1开始
2. 获取追新番最新一集的名称，如EP02
3. 去数据库里查看是否有这部剧、这集
4. 如果没有，那么补充缺失的信息

想象很美好，但是一定会有问题。总是有一些电影之类的资源的

## 3.2 新剧追加策略

新剧就完全没这个问题了。只需要找到离线数据库中没有的剧集，就可以无脑添加了。可以手动操作

## 3.3 手动策略

指定pid，强制从追新番覆盖离线数据库。这是最简单的方式了，甚至可以通过跑cron完成。

# 4. 实现难点

* 需要配合 selenium，并且需要在selenium中感知到cc检测结束的时候。
* 完整合并很复杂，不好实现

# 5. 建议

1. 目前追新番还活着，但是是否有被关闭的风险还无法得知
2. 爬取代价比较大，可能会考虑使用手动策略，毕竟本站的主要目的之一也是离线归档而不是更新
3. 我太懒了，手动更新太累了，除非有用户给我提issue否则我是不没有更新的想法的   
4. 如果能够联系到追新番的负责人，他们能够提供接口或者数据，那么就更容易了。
